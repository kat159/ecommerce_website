// @ts-nocheck
// This file is generated by Umi automatically
// DO NOT CHANGE IT MANUALLY!
/// <reference types="D:/CODING_STUDY/fontend/ecommerce_website/node_modules/@ant-design/pro-components" />
import { Link, useLocation, useNavigate, Outlet, useAppData, useRouteData, matchRoutes } from 'umi';
import type { IRoute } from 'umi';
import React, { useMemo } from 'react';
import {
  ProLayout,
} from "D:/CODING_STUDY/fontend/ecommerce_website/node_modules/@ant-design/pro-components";
import './Layout.less';
import Logo from './Logo';
import Exception from './Exception';
import { getRightRenderContent } from './rightRender';
import { useModel } from '@@/plugin-model';
import { useAccessMarkedRoutes } from '@@/plugin-access';
import { useIntl } from '@@/plugin-locale';

// 过滤出需要显示的路由, 这里的filterFn 指 不希望显示的层级
const filterRoutes = (routes: IRoute[], filterFn: (route: IRoute) => boolean) => {
  if (routes.length === 0) {
    return []
  }

  let newRoutes = []
  for (const route of routes) {
    const newRoute = {...route };
    if (filterFn(route)) {
      if (Array.isArray(newRoute.routes)) {
        newRoutes.push(...filterRoutes(newRoute.routes, filterFn))
      }
    } else {
      if (Array.isArray(newRoute.children)) {
        newRoute.children = filterRoutes(newRoute.children, filterFn);
        newRoute.routes = newRoute.children;
      }
      newRoutes.push(newRoute);
    }
  }

  return newRoutes;
}

// 格式化路由 处理因 wrapper 导致的 菜单 path 不一致
const mapRoutes = (routes: IRoute[]) => {
  if (routes.length === 0) {
    return []
  }
  return routes.map(route => {
    // 需要 copy 一份, 否则会污染原始数据
    const newRoute = {...route}
    if (route.originPath) {
      newRoute.path = route.originPath
    }

    if (Array.isArray(route.routes)) {
      newRoute.routes = mapRoutes(route.routes);
    }

    if (Array.isArray(route.children)) {
      newRoute.children = mapRoutes(route.children);
    }

    return newRoute
  })
}

export default (props: any) => {
  const location = useLocation();
  const navigate = useNavigate();
  const { clientRoutes, pluginManager } = useAppData();
  const initialInfo = (useModel && useModel('@@initialState')) || {
    initialState: undefined,
    loading: false,
    setInitialState: null,
  };
  const { initialState, loading, setInitialState } = initialInfo;
  const userConfig = {
  "locale": true,
  "navTheme": "light",
  "colorPrimary": "#1890ff",
  "layout": "mix",
  "contentWidth": "Fluid",
  "fixedHeader": false,
  "fixSiderbar": true,
  "colorWeak": false,
  "title": "Ecommerce Admin",
  "pwa": true,
  "logo": "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjc3NjcxMTA4Njg5IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjE0Mjc2IiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiPjxwYXRoIGQ9Ik0xNzAuNjY3MDA4IDcxMy4zNzk4NHYxOTYuODQyNDk2aDY4Mi42NjU5ODR2LTE5Ni44NDM1Mkw2NjkuNzg4MTYgNjI1Ljc3ODY4OEgzNTQuMjExODRMMTcwLjY2NzAwOCA3MTMuMzc5ODR6IG0tMjQuNTA0MzItNTEuMzQxMzEybDE4My41NDY4OC04Ny42MDIxNzZhNTYuODg5MzQ0IDU2Ljg4OTM0NCAwIDAgMSAyNC41MDQzMi01LjU0NzAwOGgzMTUuNTczMjQ4YzguNDc4NzIgMCAxNi44NTA5NDQgMS44OTQ0IDI0LjUwNDMyIDUuNTQ3MDA4bDE4My41NDU4NTYgODcuNjAyMTc2YTU2Ljg4OTM0NCA1Ni44ODkzNDQgMCAwIDEgMzIuMzg1MDI0IDUxLjM0MTMxMnYxOTYuODQyNDk2YzAgMzEuNDE4MzY4LTI1LjQ2OTk1MiA1Ni44ODgzMi01Ni44ODkzNDQgNTYuODg4MzJIMTcwLjY2NzAwOGMtMzEuNDE5MzkyIDAtNTYuODg5MzQ0LTI1LjQ2OTk1Mi01Ni44ODkzNDQtNTYuODg4MzJ2LTE5Ni44NDM1MmE1Ni44ODkzNDQgNTYuODg5MzQ0IDAgMCAxIDMyLjM4NTAyNC01MS4zNDAyODh6TTUxMiA0NTUuMTEwNjU2Yzk0LjI1NjEyOCAwIDE3MC42NjcwMDgtNzYuNDA5ODU2IDE3MC42NjcwMDgtMTcwLjY2NTk4NCAwLTk0LjI1NzE1Mi03Ni40MTA4OC0xNzAuNjY3MDA4LTE3MC42NjcwMDgtMTcwLjY2NzAwOHMtMTcwLjY2NzAwOCA3Ni40MTA4OC0xNzAuNjY3MDA4IDE3MC42NjcwMDhTNDE3Ljc0Mzg3MiA0NTUuMTEwNjU2IDUxMiA0NTUuMTEwNjU2ek01MTIgNTEyYy0xMjUuNjc1NTIgMC0yMjcuNTU1MzI4LTEwMS44Nzk4MDgtMjI3LjU1NTMyOC0yMjcuNTU1MzI4UzM4Ni4zMjQ0OCA1Ni44ODkzNDQgNTEyIDU2Ljg4OTM0NHMyMjcuNTU1MzI4IDEwMS44Nzk4MDggMjI3LjU1NTMyOCAyMjcuNTU1MzI4UzYzNy42NzU1MiA1MTIgNTEyIDUxMnogbTg1LjMzMjk5MiAyMjcuNTU1MzI4aDExMy43Nzc2NjRjMTUuNzEwMjA4IDAgMjguNDQ0NjcyIDEyLjczNTQ4OCAyOC40NDQ2NzIgMjguNDQ0Njcycy0xMi43MzQ0NjQgMjguNDQ0NjcyLTI4LjQ0NDY3MiAyOC40NDQ2NzJoLTExMy43NzY2NGMtMTUuNzEwMjA4IDAtMjguNDQ0NjcyLTEyLjczNTQ4OC0yOC40NDQ2NzItMjguNDQ0NjcyczEyLjczNDQ2NC0yOC40NDQ2NzIgMjguNDQzNjQ4LTI4LjQ0NDY3MnoiIGZpbGw9IiMzMjMyMzMiIHAtaWQ9IjE0Mjc3Ij48L3BhdGg+PC9zdmc+",
  "iconfontUrl": "",
  "token": {}
};
const { formatMessage } = useIntl();
  const runtimeConfig = pluginManager.applyPlugins({
    key: 'layout',
    type: 'modify',
    initialValue: {
      ...initialInfo
    },
  });

  console.log('clientRoutes', clientRoutes)
  // 现在的 layout 及 wrapper 实现是通过父路由的形式实现的, 会导致路由数据多了冗余层级, proLayout 消费时, 无法正确展示菜单, 这里对冗余数据进行过滤操作
  const newRoutes = filterRoutes(clientRoutes.filter(route => route.id === 'ant-design-pro-layout'), (route) => {
    return (!!route.isLayout && route.id !== 'ant-design-pro-layout') || !!route.isWrapper;
  })
  const [route] = useAccessMarkedRoutes(mapRoutes(newRoutes));

  const matchedRoute = useMemo(() => matchRoutes(route.children, location.pathname)?.pop?.()?.route, [location.pathname]);

  return (
    <ProLayout
      route={route}
      location={location}
      title={userConfig.title || 'plugin-layout'}
      navTheme="dark"
      siderWidth={256}
      onMenuHeaderClick={(e) => {
        e.stopPropagation();
        e.preventDefault();
        navigate('/');
      }}
      formatMessage={userConfig.formatMessage || formatMessage}
      menu={{ locale: userConfig.locale }}
      logo={Logo}
      menuItemRender={(menuItemProps, defaultDom) => {
        if (menuItemProps.isUrl || menuItemProps.children) {
          return defaultDom;
        }
        if (menuItemProps.path && location.pathname !== menuItemProps.path) {
          return (
            // handle wildcard route path, for example /slave/* from qiankun
            <Link to={menuItemProps.path.replace('/*', '')} target={menuItemProps.target}>
              {defaultDom}
            </Link>
          );
        }
        return defaultDom;
      }}
      itemRender={(route) => <Link to={route.path}>{route.breadcrumbName}</Link>}
      disableContentMargin
      fixSiderbar
      fixedHeader
      {...runtimeConfig}
      rightContentRender={
        runtimeConfig.rightContentRender !== false &&
        ((layoutProps) => {
          const dom = getRightRenderContent({
            runtimeConfig,
            loading,
            initialState,
            setInitialState,
          });
          if (runtimeConfig.rightContentRender) {
            return runtimeConfig.rightContentRender(layoutProps, dom, {
              // BREAK CHANGE userConfig > runtimeConfig
              userConfig,
              runtimeConfig,
              loading,
              initialState,
              setInitialState,
            });
          }
          return dom;
        })
      }
    >
      <Exception
        route={matchedRoute}
        noFound={runtimeConfig?.noFound}
        notFound={runtimeConfig?.notFound}
        unAccessible={runtimeConfig?.unAccessible}
        noAccessible={runtimeConfig?.noAccessible}
      >
        {runtimeConfig.childrenRender
          ? runtimeConfig.childrenRender(<Outlet />, props)
          : <Outlet />
        }
      </Exception>
    </ProLayout>
  );
}
